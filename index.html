<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>EdiCuaTeX - LaTeX Equation Editor</title>
    <script>
        // Check if it's in eXe and translate (if possible)
        let isInExe = parent && typeof(parent.eXeLearning) == 'object' && typeof(parent.tinymce) == 'object';
        // Redefine _ function once the DOM is loaded and $i18n is available
        document.addEventListener("DOMContentLoaded", function() {
            _ = function(str){
                let res = str;
                let appLang = document.documentElement.lang;
                // Ensure $i18n is defined
                if (typeof $i18n === 'undefined') {
                    console.warn('$i18n dictionary not found. Using fallback.');
                    // Fallback for eXe environment
                    if (isInExe && parent && typeof parent._ === 'function') return parent._(str);
                    // Fallback for standalone
                    return str;
                }
                // Default language is English (from eXe key)
                let translations = $i18n['eXe'];
                // Check if translations for the current language exist
                if (typeof $i18n[appLang] == 'object') {
                    translations = $i18n[appLang];
                }
                // Return the translation if available
                if (typeof translations[str] == 'string') {
                    return translations[str];
                }
                // If not found in local dictionary, try eXe's dictionary
                if (isInExe && parent && typeof parent._ === 'function') {
                    return parent._(str);
                }
                // Otherwise, return the original string
                return res;
            }

            // After defining _, update all texts
            if (!isInExe) {
                setupLanguageSelector();
            }
            updateAllDynamicTexts();
            addFooter(); // Ensure footer is translated on load
        });

        if (isInExe) {
            // Set HTML lang based on eXe's language
            document.documentElement.lang = parent.eXeLearning.app.locale.lang;
        } else {
            // Setup for standalone execution (browser language detection or localStorage)
            const savedLang = localStorage.getItem('userLanguage');
            const browserLang = navigator.language.split('-')[0];
            const supportedLangs = ['en', 'es', 'ca'];
            const defaultLang = savedLang || (supportedLangs.includes(browserLang) ? browserLang : 'en');
            document.documentElement.lang = defaultLang;
        }
    </script>
    <script src="translations.js"></script>
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/color', '[tex]/mhchem']
            },
            tex: {
                inlineMath: [
                    ['\\(', '\\)']],
                displayMath: [
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: true,
                packages: {
                    '[+]': ['cases', 'mathtools', 'color', 'mhchem']
                }
            },
            svg: {
                fontCache: 'local'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    // This function is defined below in the main script
                    if (window.initializeLatexEditor) {
                        window.initializeLatexEditor();
                    }
                }
            }
        };
    </script>
    <script async="" id="MathJax-script" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --danger-dark: #a71d2a;
            --success-color: #28a745;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --white: #ffffff;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--white);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .language-selector {
            display: none; /* Hidden by default, shown by JS if not in eXe */
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .lang-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .lang-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .lang-btn.active {
            background-color: white;
            color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .tabs-section {
            position: relative;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .search-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px 10px 20px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .search-input-container {
            position: relative;
            flex-grow: 1;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        #search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        #clear-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 1.8rem;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            display: none;
        }
        
        #clear-search-btn:hover {
            color: var(--dark-gray);
        }
        
        #settings-btn, #maximize-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            transition: transform 0.3s, color 0.3s;
            padding: 0 5px;
            flex-shrink: 0;
        }
        
        #settings-btn:hover, #maximize-btn:hover {
            color: var(--primary-color);
            transform: rotate(45deg);
        }

        #maximize-btn:hover {
             transform: scale(1.2);
        }
        
        .search-results-view .tabs-container {
            display: none;
        }
        
        .search-results-view .tab-content {
            display: grid !important;
        }
        
        .tabs-container {
            display: flex;
            flex-wrap: wrap;
            background: var(--light-gray);
            border-bottom: 3px solid var(--medium-gray);
        }
        
        .tab-btn {
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-gray);
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
            background: var(--medium-gray);
            color: var(--text-color);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .toolbar-wrapper {
            padding: 20px;
            background: var(--white);
        }
        
        .tab-content {
            display: none;
            gap: 10px;
        }
        
        .tab-content.active {
            display: grid;
        }
        
        .toolbar-btn {
            background: var(--white);
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            font-size: 0.85rem;
        }
        
        .toolbar-btn:hover {
            border-color: var(--primary-color);
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        .toolbar-btn svg {
            max-width: 100%;
            height: auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
        }
        
        .panel-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 15px 0;
            border-bottom: 2px solid var(--medium-gray);
            padding-bottom: 10px;
        }
        
        .panel-title-container h2 {
            margin: 0;
            padding: 0;
            border: none;
            color: #333;
            font-size: 1.3rem;
        }
        
        #ask-ai-btn {
            padding: 6px 12px;
            background: linear-gradient(45deg, #6c757d, #343a40);
            color: white;
            font-size: 0.9em;
        }
        
        #latex-input {
            width: 100%;
            height: 200px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            flex-grow: 1;
        }
        
        #latex-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .preview-container {
            min-height: 200px;
            border: 2px dashed var(--medium-gray);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            flex-grow: 1;
        }
        
        #preview {
            font-size: 24px;
            color: var(--text-color);
            overflow-x: auto;
            overflow-y: hidden;
            width: 100%;
            text-align: center;
        }
        
        .copy-options-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .copy-options-container label {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        #delimiter-selector {
            font-family: inherit;
            padding: 5px 8px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            background-color: white;
            transition: border-color 0.2s ease-in-out;
        }
        
        #delimiter-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .panel-actions {
            margin-top: 15px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary-color), #495057);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), var(--danger-dark));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #1e7e34);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        
        .copy-feedback {
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 10px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            max-width: 90vw;
            max-height: 90vh;
            text-align: left;
            transform: scale(0.9);
            transition: transform 0.3s;
            width: 600px;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-content h2,
        .modal-content h3 {
            text-align: center;
            margin-top: 0;
            color: var(--text-color);
        }
        
        .modal-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            border-top: 1px solid var(--medium-gray);
            padding-top: 20px;
            font-size: 1.1rem;
        }
        
        #modal-message {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            line-height: 1.5;
            text-align: center;
        }
        
        #modal-message img {
            display: block;
            margin: 0 auto;
        }
        
        #alert-modal-message p {
            margin: 0 0 10px 0;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-content .form-group {
            margin-bottom: 20px;
        }
        
        .modal-content .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .modal-content .form-group input,
        .modal-content .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            font-size: 1rem;
        }
        
        #ai-modal .form-group textarea {
            resize: vertical;
            font-family: 'Segoe UI', sans-serif;
        }
        
        #ai-modal .form-group textarea[readonly] {
            background-color: var(--light-gray);
            cursor: text;
        }
        
        #modal-feedback {
            font-size: 0.9em;
            height: 20px;
            text-align: center;
        }
        
        .modal-body {
            overflow-y: auto;
            padding-right: 15px;
            margin-right: -15px;
        }
        
        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .menu-list li {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .menu-list li:nth-child(odd) {
            background-color: var(--light-gray);
        }
        
        .menu-list-item-name {
            font-weight: 500;
            margin-left: 10px;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: white;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .footer a {
            color: #ffffff;
            font-weight: 600;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        #clear-recents-btn-container {
            text-align: right;
            margin-top: 10px;
        }
        
        .matrix-builder {
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 10px 15px;
            background-color: var(--light-gray);
        }
        
        .matrix-builder-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .matrix-builder-group label {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--dark-gray);
            white-space: nowrap;
        }
        
        .matrix-builder-group input,
        .matrix-builder-group select {
            padding: 6px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            font-size: 0.9rem;
            width: 65px;
        }
        
        .matrix-builder-group select {
            width: auto;
            min-width: 140px;
        }
        
        .matrix-builder-delimiters {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .matrix-builder-delimiters .btn {
            padding: 6px 14px;
            font-size: 1.1rem;
        }
        
        #maximize-btn {
            position: static !important;
            margin-left: 6px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 2rem;
            }
            .tab-btn {
                padding: 12px 15px;
                font-size: 14px;
            }
            .container {
                padding: 10px;
            }
            .modal-content {
                padding: 20px;
            }
            .matrix-builder {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1 data-i18n-key="EdiCuaTeX - LaTeX Equation Editor">EdiCuaTeX - LaTeX Equation Editor</h1>
            <p data-i18n-key="Create mathematical formulas visually, copy them or download them as images.">Create mathematical formulas visually, copy them or download them as images.</p>
            <div class="language-selector" id="language-selector">
                <button class="lang-btn" data-lang="en" id="lang-en">EN</button>
                <button class="lang-btn" data-lang="es" id="lang-es">ES</button>
                <button class="lang-btn" data-lang="ca" id="lang-ca">CA</button>
            </div>
        </header>
        <div class="tabs-section" id="tabs-section">
            <div class="search-wrapper">
                <div class="search-input-container">
                    <input autocomplete="off" id="search-input" placeholder="Search by description or code (e.g.: fraction, \int)..." type="search" data-i18n-placeholder="Search by description or code (e.g.: fraction, \int)..."/>
                    <button id="clear-search-btn" title="Clear search" data-i18n-title="Clear search">×</button>
                </div>
                <button id="settings-btn" title="Customize menu" data-i18n-title="Customize menu">⚙️</button>
                <button id="maximize-btn" title="Fullscreen" data-i18n-title="Fullscreen">🗖</button>
            </div>
            <div class="tabs-container" id="tabs-container"></div>
            <div class="toolbar-wrapper">
                <div id="toolbar"></div>
            </div>
        </div>
        <div class="main-content">
            <div class="panel">
                <div class="panel-title-container">
                    <h2 data-i18n-key="LaTeX Code">LaTeX Code</h2>
                    <button class="btn btn-sm" id="ask-ai-btn" title="Ask AI for formula" data-i18n-title="Ask AI for formula">✨ <span data-i18n-key="AI Assistant">AI Assistant</span></button>
                </div>
                <textarea id="latex-input" placeholder="Write your code here... \frac{a}{b}" spellcheck="false" data-i18n-placeholder="Write your code here... \frac{a}{b}"></textarea>
                <div class="copy-options-container">
                    <label for="delimiter-selector" data-i18n-key="Formula delimiters:">Formula delimiters:</label>
                    <select class="mathjax_ignore" id="delimiter-selector">
                        <option selected="" value="none" data-i18n-key="No delimiter">No delimiter</option>
                        <option value="parentheses">\(...\)</option>
                        <option value="brackets">\[...\]</option>
                        <option value="double_dollar">$$...$$</option>
                        <option value="single_dollar">$...$</option>
                    </select>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-success" id="insert-button" data-i18n-key="Insert">Insert</button>
                    <button class="btn btn-primary" id="copy-button" data-i18n-key="Copy">Copy</button>
                    <button class="btn btn-secondary" id="clear-button" data-i18n-key="Delete">Delete</button>
                </div>
                <div class="copy-feedback" id="copy-code-feedback"></div>
            </div>
            <div class="panel">
                <div class="panel-title-container">
                    <h2 data-i18n-key="Preview">Preview</h2>
                </div>
                <div class="preview-container">
                    <div id="preview"></div>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-success" id="view-image-button" data-i18n-key="View image">View image</button>
                </div>
                <div class="copy-feedback" id="copy-image-feedback"></div>
            </div>
        </div>
    </div>
    <footer class="footer" id="page-footer"></footer>
    <div class="modal-overlay" id="image-modal">
        <div class="modal-content">
            <div id="modal-message"></div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h2 data-i18n-key="Manage menus">Manage menus</h2>
            <p style="text-align:center; margin-bottom: 12px;">
                <span data-i18n-key="You can edit your own menus with the">You can edit your own menus with the</span>
                <a href="editor_menu.html" target="_blank" rel="noopener noreferrer" data-i18n-key="Menu Editor">Menu Editor</a>.
            </p>
            <div class="modal-body">
                <h3 data-i18n-key="Available menus">Available menus</h3>
                <ul class="menu-list" id="available-menus-list">
                    <li data-i18n-key="Loading...">Loading...</li>
                </ul>
                <div class="modal-buttons" style="justify-content: flex-end; margin-top: 10px;">
                    <button class="btn btn-sm btn-secondary" id="reload-menus-list-btn" style="display:none;" data-i18n-key="Reload list">Reload list</button>
                </div>
                <h3 data-i18n-key="Custom load">Custom load</h3>
                <div class="form-group">
                    <label for="url-input" data-i18n-key="Load menu from external URL">Load menu from external URL</label>
                    <div style="display: flex; gap: 10px;">
                        <input id="url-input" placeholder="https://example.com/base.json" type="url" style="flex-grow: 1;" />
                        <button class="btn btn-success btn-sm" id="load-url-btn" data-i18n-key="Load">Load</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="file-input" data-i18n-key="Load menu from local file">Load menu from local file</label>
                    <input accept=".json,application/json" id="file-input" type="file" />
                </div>
                <div id="modal-feedback" style="margin-bottom: 15px;"></div>
                <div class="modal-buttons" style="flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="clear-cache-btn" data-i18n-key="Clear cache and reload">Clear cache and reload</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="close-settings-btn" data-i18n-key="Close">Close</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="ai-modal">
        <div class="modal-content">
            <h2 data-i18n-key="AI Formula Assistant">AI Formula Assistant</h2>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px;" data-i18n-key="Describe the formula or mathematical expression you need. The assistant will generate an instruction (prompt) for you to use in an AI model like ChatGPT.">Describe the formula or mathematical expression you need. The assistant will generate an instruction (prompt) for you to use in an AI model like ChatGPT.</p>
                <div class="form-group">
                    <label for="ai-user-prompt" data-i18n-key="Describe your formula:">1. Describe your formula:</label>
                    <textarea id="ai-user-prompt" placeholder="E.g.: Quadratic equation with a=1, b=14 and c=-4" rows="3" data-i18n-placeholder="E.g.: Quadratic equation with a=1, b=14 and c=-4"></textarea>
                </div>
                <div class="modal-buttons" style="margin-top: 0; margin-bottom: 20px;">
                    <button class="btn btn-secondary" id="generate-ai-prompt-btn" data-i18n-key="Generate AI instruction">2. Generate AI instruction</button>
                </div>
                <div class="form-group">
                    <label for="ai-generated-prompt" data-i18n-key="Generated instruction:">3. Generated instruction:</label>
                    <textarea id="ai-generated-prompt" placeholder="The AI instruction will appear here..." readonly="" rows="4" data-i18n-placeholder="The AI instruction will appear here..."></textarea>
                </div>
                <div class="copy-feedback" id="ai-feedback" style="height: auto; margin-bottom: 15px; margin-top: -10px;"></div>
            </div>
            <div class="modal-buttons">
                <a class="btn btn-primary" href="#" id="open-chatgpt-btn" style="display: none;" target="_blank" data-i18n-key="Open in ChatGPT">Open in ChatGPT</a>
                <button class="btn btn-success" id="copy-ai-prompt-btn" style="display: none;" data-i18n-key="Copy for another AI">Copy for another AI</button>
                <button class="btn btn-secondary" id="close-ai-modal-btn" data-i18n-key="Close">Close</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="alert-modal">
        <div class="modal-content">
            <h2 id="alert-modal-title" style="text-align: center;"></h2>
            <div id="alert-modal-message" style="font-size: 1rem; line-height: 1.5;"></div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="alert-modal-close-btn" data-i18n-key="Understood">Understood</button>
            </div>
        </div>
    </div>
    <script>
        // Global placeholder for the translation function
        let _ = str => str;

        // --- Language & UI Update Functions ---
        function setupLanguageSelector() {
            const languageSelector = document.getElementById('language-selector');
            if (!languageSelector || isInExe) return;

            languageSelector.style.display = 'flex';
            const langButtons = document.querySelectorAll('.lang-btn');
            const currentLang = document.documentElement.lang;

            langButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
                btn.addEventListener('click', () => changeLanguage(btn.dataset.lang));
            });
        }

        function changeLanguage(newLang) {
            document.documentElement.lang = newLang;
            localStorage.setItem('userLanguage', newLang);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === newLang);
            });
            updateAllDynamicTexts();
            addFooter(); // Retranslate footer
        }

        function updateAllDynamicTexts() {
            document.title = _('EdiCuaTeX - LaTeX Equation Editor');
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                // Special handling for elements with mixed content (e.g., text and a link)
                if (el.querySelector('a[data-i18n-key]')) {
                    const link = el.querySelector('a');
                    const linkKey = link.getAttribute('data-i18n-key');
                    link.textContent = _(linkKey);
                    // The main text needs a placeholder for the link, e.g., "Text with %s"
                    // This is complex, so we just translate the text part for now.
                    const textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                    if (textNode) {
                       textNode.textContent = _(key) + " ";
                    }
                } else if (el.closest('button#ask-ai-btn')) {
                    el.textContent = " " + _(key); // Keep space for emoji
                } else {
                    el.textContent = _(key);
                }
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => el.title = _(el.getAttribute('data-i18n-title')));
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = _(el.getAttribute('data-i18n-placeholder')));
            
            // Rebuild UI parts that are created dynamically
            if (window.rebuildToolbarAndUI) {
                window.rebuildToolbarAndUI();
            }
        }
        
        // This function must be available globally to be called from the DOMContentLoaded listener
        function addFooter() {
            const footer = document.getElementById('page-footer');
            if (footer) {
                footer.innerHTML = `<p style="margin-bottom: 10px;"><a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener noreferrer">${_('Educational Applications Laboratory')}</a> | <a href="https://bilateria.org" target="_blank" rel="noopener noreferrer">${_('Application created by Juan José de Haro')}</a></p><p style="margin-bottom: 10px;"><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" rel="noopener noreferrer">Licencia Creative Commons BY-SA</a></p><p style="margin-top: 20px; font-size: 0.8em; opacity: 0.7;">v4.52</p>`;
            }
        };

        // --- Main Application Logic ---
        async function initializeLatexEditor() {
            // --- DOM REFERENCES ---
            const latexInput = document.getElementById('latex-input');
            const preview = document.getElementById('preview');
            const copyButton = document.getElementById('copy-button');
            const clearButton = document.getElementById('clear-button');
            const insertButton = document.getElementById('insert-button');
            const viewImageButton = document.getElementById('view-image-button');
            const delimiterSelector = document.getElementById('delimiter-selector');
            const copyCodeFeedback = document.getElementById('copy-code-feedback');
            const tabsContainer = document.getElementById('tabs-container');
            const toolbar = document.getElementById('toolbar');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const settingsBtn = document.getElementById('settings-btn');
            // Modals
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const urlInput = document.getElementById('url-input');
            const fileInput = document.getElementById('file-input');
            const loadUrlBtn = document.getElementById('load-url-btn'); // <-- New button reference
            const modalFeedback = document.getElementById('modal-feedback');
            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');
            const availableMenusList = document.getElementById('available-menus-list');
            const reloadMenusListBtn = document.getElementById('reload-menus-list-btn');
            const clearCacheBtn = document.getElementById('clear-cache-btn');
            // AI Modal
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
            const aiUserPrompt = document.getElementById('ai-user-prompt');
            const generateAiPromptBtn = document.getElementById('generate-ai-prompt-btn');
            const aiGeneratedPrompt = document.getElementById('ai-generated-prompt');
            const openChatGptBtn = document.getElementById('open-chatgpt-btn');
            const copyAiPromptBtn = document.getElementById('copy-ai-prompt-btn');
            const aiFeedback = document.getElementById('ai-feedback');
            const maximizeBtn = document.getElementById('maximize-btn');

            // --- Helper functions for initialization ---
            function stripLatexDelimiters(code) {
                if (!code) return code;
                const trimmed = code.trim();
                const patterns = [
                    /^\\\(([\s\S]+?)\\\)$/,   // \( ... \)
                    /^\\\[([\s\S]+?)\\\]$/,   // \\[ ... \\]
                    /^\$\$([\s\S]+?)\$\$$/,     // $$ ... $$
                    /^\$([\s\S]+?)\$$/        // $ ... $
                ];
                for (const p of patterns) {
                    const m = trimmed.match(p);
                    if (m) return m[1].trim();
                }
                return trimmed;
            }

            function autoPickDelimiter(latexFragment){
                const selectorEl = document.getElementById('delimiter-selector');
                if(!selectorEl || !latexFragment) return;
                const frag = latexFragment.trim();
                
                if(/^\\\(.+?\\\)$/.test(frag)){ selectorEl.value = 'parentheses'; return; }
                if(/^\\\[([\s\S]+?)\\\]$/.test(frag)){ selectorEl.value = 'brackets'; return; }
                if(/^\$\$([\s\S]+?)\$\$$/.test(frag)){ selectorEl.value = 'double_dollar'; return; }
                if(/^\$([\s\S]+?)\$$/.test(frag)){ selectorEl.value = 'single_dollar'; return; }

                // If no delimiter is found, default based on context
                selectorEl.value = isInExe ? 'parentheses' : 'none';
            }
            
            // --- Contextual UI Adjustments & Initialization ---
            if (isInExe) {
                // Hide elements not needed inside the eXeLearning plugin view
                const headerEl = document.querySelector('.header');
                const footerEl = document.querySelector('.footer');
                if (headerEl) headerEl.style.display = 'none';
                if (footerEl) footerEl.style.display = 'none';

                // Inside eXe, we "Insert", so "Copy" is less relevant and can be hidden.
                if (copyButton) copyButton.style.display = 'none';

                // Also, limit the available delimiters for the eXe context
                if (delimiterSelector) {
                    const allowedDelims = ['none', 'parentheses', 'brackets'];
                    Array.from(delimiterSelector.options).forEach(opt => {
                        if (!allowedDelims.includes(opt.value)) {
                            opt.remove();
                        }
                    });
                     // Set a sensible default if no formula is pre-filled
                    if (!latexInput.value.trim()) {
                        delimiterSelector.value = 'parentheses';
                    }
                }

            } else {
                // When running standalone (outside eXe), the "Insert" button has no target editor.
                if (insertButton) insertButton.style.display = 'none';
            }

            // --- Prefill from eXeLearning Selection (URL Parameter) ---
            const urlSel = new URLSearchParams(window.location.search).get('sel');
            if (urlSel) {
                const originalSel = decodeURIComponent(urlSel);
                autoPickDelimiter(originalSel);
                latexInput.value = stripLatexDelimiters(originalSel);
            }

            // Prefill from other potential eXe dialogs (legacy support)
            try {
                if (window.opener && window.opener.PasteMathDialog && window.opener.PasteMathDialog.mathEditor && window.opener.PasteMathDialog.mathEditor.field) {
                    const parentLatex = window.opener.PasteMathDialog.mathEditor.field.val().trim();
                    if (parentLatex) {
                        autoPickDelimiter(parentLatex);
                        latexInput.value = stripLatexDelimiters(parentLatex);
                    }
                }
            } catch (err) {
                console.warn(_('Could not get code from parent dialog:'), err);
            }

            // --- CONFIG & STATE ---
            const MANIFEST_URL = './menus.json';
            const MAX_RECENTS = 12;
            let loadedMenus = new Map();
            let menuCache = new Map();
            let recentSymbols = [];
            
            // --- CORE FUNCTIONS (RESTORED AND INTERNATIONALIZED) ---

            const loadRecents = () => { recentSymbols = JSON.parse(localStorage.getItem('latexRecents')) || []; };
            const saveRecents = () => { localStorage.setItem('latexRecents', JSON.stringify(recentSymbols)); };
            const clearRecents = () => { recentSymbols = []; localStorage.removeItem('latexRecents'); rebuildToolbarAndUI(); };
            
            const createRecentsTab = () => {
                if (document.querySelector('[data-tab="recientes"]')) return;
                const recentsTabButton = document.createElement('button');
                recentsTabButton.className = 'tab-btn';
                recentsTabButton.dataset.tab = 'recientes';
                recentsTabButton.textContent = _('Recent');
                tabsContainer.prepend(recentsTabButton);
                const recentsContentDiv = document.createElement('div');
                recentsContentDiv.id = 'tab-recientes';
                recentsContentDiv.className = 'tab-content';
                toolbar.prepend(recentsContentDiv);
            };

            const trackSymbolUsage = (latexCode) => {
                const wasEmpty = recentSymbols.length === 0;
                recentSymbols = recentSymbols.filter(item => item !== latexCode);
                recentSymbols.unshift(latexCode);
                if (recentSymbols.length > MAX_RECENTS) recentSymbols = recentSymbols.slice(0, MAX_RECENTS);
                saveRecents();
                if (wasEmpty) {
                    createRecentsTab();
                    renderTabContent('recientes', getAllCategories());
                } else {
                    const recentsContent = document.getElementById('tab-recientes');
                    if (recentsContent && recentsContent.classList.contains('active')) {
                        renderTabContent('recientes', getAllCategories());
                    }
                }
            };
            
            const saveAddedMenusToStorage = () => {
                const added = Array.from(loadedMenus.values())
                    .filter(m => m.source !== 'default' && m.source !== 'localfile')
                    .map(m => ({ id: m.id, url: m.url, source: m.source, name: m.name }));
                localStorage.setItem('latexAddedMenus', JSON.stringify(added));
            };

            const loadAddedMenusFromStorage = () => JSON.parse(localStorage.getItem('latexAddedMenus')) || [];

            const fetchMenuData = async (url) => {
                if (menuCache.has(url)) return menuCache.get(url);
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    menuCache.set(url, data);
                    return data;
                } catch (error) {
                    console.error(_('Error loading menu') + ` ${url}:`, error);
                    showModalFeedback(_('Could not load') + ` ${url}`, true);
                    return null;
                }
            };

            const addMenu = async (menuInfo) => {
                if (loadedMenus.has(menuInfo.id)) return;
                const data = await fetchMenuData(menuInfo.url);
                if (data) {
                    loadedMenus.set(menuInfo.id, { ...menuInfo, data });
                    rebuildToolbarAndUI();
                    saveAddedMenusToStorage();
                }
            };
            
            const removeMenu = (menuId) => {
                if (loadedMenus.has(menuId)) {
                    loadedMenus.delete(menuId);
                    rebuildToolbarAndUI();
                    saveAddedMenusToStorage();
                }
            };

            const getAllCategories = () => {
                const allCategories = new Map();
                const menuOrder = ['default', 'github', 'url', 'localfile'];
                const sortedMenus = Array.from(loadedMenus.values()).sort((a,b) => menuOrder.indexOf(a.source) - menuOrder.indexOf(b.source));
                for (const menu of sortedMenus) {
                    if (!menu.data || !menu.data.categorias) continue;
                    for (const categoria of menu.data.categorias) {
                        if (!allCategories.has(categoria.id)) {
                             allCategories.set(categoria.id, { ...categoria, elementos: [...categoria.elementos] });
                        } else {
                            allCategories.get(categoria.id).elementos.push(...categoria.elementos);
                        }
                    }
                }
                return allCategories;
            };

            window.rebuildToolbarAndUI = () => {
                tabsContainer.innerHTML = '';
                toolbar.innerHTML = '';
                const allCategories = getAllCategories();
                let isFirstTab = true;

                if (recentSymbols.length > 0) {
                    createRecentsTab();
                    isFirstTab = false;
                }

                allCategories.forEach((categoria) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'tab-btn';
                    tabButton.dataset.tab = categoria.id;
                    tabButton.textContent = _(categoria.nombre); // Translate category name
                    tabsContainer.appendChild(tabButton);
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `tab-${categoria.id}`;
                    contentDiv.className = 'tab-content';
                    toolbar.appendChild(contentDiv);
                });

                // Set active tab after creating all of them
                let activeTab = tabsContainer.querySelector('.tab-btn.active');
                if (!activeTab) {
                    const firstTab = tabsContainer.querySelector('[data-tab="recientes"]') || tabsContainer.querySelector('.tab-btn');
                    if (firstTab) {
                        activeTab = firstTab;
                    }
                }
                
                if (activeTab) {
                   activeTab.classList.add('active');
                   const activeContent = document.getElementById(`tab-${activeTab.dataset.tab}`);
                   if (activeContent) activeContent.classList.add('active');
                   renderTabContent(activeTab.dataset.tab, allCategories);
                } else {
                   // Fallback if no tabs exist at all
                   toolbar.innerHTML = `<p>${_('No menus found.')}</p>`;
                }
                
                loadAndDisplayAvailableMenus();
            };

            async function loadAndDisplayAvailableMenus(forceReload = false) {
                const menuItemsMap = new Map();
                if (window.__manifestMenus) {
                    window.__manifestMenus.forEach(menuItem => {
                        const id = menuItem.file;
                        menuItemsMap.set(id, {
                            id: id,
                            url: `./${id}`,
                            name: id.replace('.json', ''),
                            source: id === 'base.json' ? 'default' : 'manifest',
                            description: menuItem.description
                        });
                    });
                }
                loadedMenus.forEach(menu => { if (!menuItemsMap.has(menu.id)) menuItemsMap.set(menu.id, { ...menu }); });
                loadAddedMenusFromStorage().forEach(stored => { if (!menuItemsMap.has(stored.id)) menuItemsMap.set(stored.id, { ...stored }); });
                
                availableMenusList.innerHTML = '';
                if (menuItemsMap.size === 0) {
                    availableMenusList.innerHTML = `<li>${_('No menus found.')}</li>`;
                    return;
                }
                menuItemsMap.forEach(menu => {
                    const li = document.createElement('li');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.id = `menu-checkbox-${menu.id}`;
                    cb.checked = loadedMenus.has(menu.id);
                    cb.dataset.id = menu.id;
                    cb.dataset.url = menu.url;
                    cb.dataset.name = menu.name;
                    cb.dataset.source = menu.source;
                    const label = document.createElement('label');
                    label.htmlFor = cb.id;
                    label.className = 'menu-list-item-name';
                    
                    const menuName = _(menu.name) || menu.id;
                    const menuDescription = _(menu.description || '');

                    label.textContent = menuDescription ? `${menuName} (${menuDescription})` : menuName;
                    label.title = `${_('File')}: ${menu.id}`;
                    
                    li.appendChild(cb);
                    li.appendChild(label);
                    availableMenusList.appendChild(li);
                });
            }

            function showAlert(title, htmlMessage) {
                alertModalTitle.textContent = _(title); // Translate title
                alertModalMessage.innerHTML = htmlMessage; // Message may contain HTML
                alertModal.classList.add('active');
            }

            function hideAlert() { alertModal.classList.remove('active'); }

            function showImageModal(message, buttons) {
                document.getElementById('modal-message').innerHTML = message;
                const modalButtons = document.getElementById('modal-buttons');
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = _(btnInfo.text); // Translate button text
                    button.className = `btn ${btnInfo.class}`;
                    button.onclick = () => { if(btnInfo.action) btnInfo.action(); document.getElementById('image-modal').classList.remove('active'); };
                    modalButtons.appendChild(button);
                });
                document.getElementById('image-modal').classList.add('active');
            }

            function showModalFeedback(message, isError = false) {
                modalFeedback.textContent = message; // Already translated when called
                modalFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                setTimeout(() => modalFeedback.textContent = '', 3000);
            }

            function generateAiPrompt() {
                const userDescription = aiUserPrompt.value.trim();
                if (!userDescription) {
                    showAiFeedback(_('Please describe the formula you need.'), true);
                    return;
                }
                const prompt = `Provide the LaTeX code for the following mathematical description: "${userDescription}". The result should be only the LaTeX code, without additional explanations or delimiters like $$ or \\[ \\]. It should be ready to copy and paste directly into a LaTeX editor.`;
                aiGeneratedPrompt.value = prompt;
                openChatGptBtn.href = `https://chatgpt.com/?q=${encodeURIComponent(prompt)}`;
                openChatGptBtn.style.display = 'inline-block';
                copyAiPromptBtn.style.display = 'inline-block';
                showAiFeedback(_('Instruction generated. You can now use the buttons.'), false);
            }

            function showAiFeedback(message, isError = false) {
                aiFeedback.textContent = message; // Already translated
                aiFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                aiFeedback.style.opacity = '1';
                setTimeout(() => { if (aiFeedback.textContent === message) { aiFeedback.style.opacity = '0'; } }, 4000);
            }

            function copyAiPrompt() {
                if (!aiGeneratedPrompt.value) return;
                navigator.clipboard.writeText(aiGeneratedPrompt.value);
                showAiFeedback(_('Instruction copied to clipboard!'), false);
            }
            
            function updatePreview() {
                preview.innerHTML = latexInput.value.trim() === "" ? "" : `$$${latexInput.value.trim()}$$`;
                MathJax.typesetPromise([preview]).catch(() => { preview.innerHTML = `<span style="color:red;">${_('Syntax error')}</span>`; });
            }

            function insertAtCursor(textToInsert) {
                const startPos = latexInput.selectionStart;
                latexInput.value = latexInput.value.substring(0, startPos) + textToInsert + latexInput.value.substring(latexInput.selectionEnd);
                let cursorPos = textToInsert.indexOf('{}');
                latexInput.selectionStart = latexInput.selectionEnd = startPos + (cursorPos !== -1 ? cursorPos + 1 : textToInsert.length);
                latexInput.focus();
                updatePreview();
                if (textToInsert.includes('\\begin{')) return;
                trackSymbolUsage(textToInsert);
            }
            
            function generateImage(callback) {
                const svgElement = preview.querySelector('svg');
                if (!svgElement) { showImageModal(`<p>${_('No formula to capture.')}</p>`, [{text: _('Understood'), class: 'btn-primary'}]); return; }
                const svgString = new XMLSerializer().serializeToString(svgElement);
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const padding = 20;
                    canvas.width = svgElement.width.baseVal.value + padding * 2;
                    canvas.height = svgElement.height.baseVal.value + padding * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, padding, padding, svgElement.width.baseVal.value, svgElement.height.baseVal.value);
                    URL.revokeObjectURL(img.src);
                    callback(canvas);
                };
                img.src = URL.createObjectURL(new Blob([svgString], {type: "image/svg+xml;charset=utf-8"}));
            }
            
            function handleViewImage() {
                generateImage(canvas => {
                    const message = `<div><img src="${canvas.toDataURL('image/png')}" style="max-width: 100%; max-height: 80vh;"><p>${_('Right-click on the image to save or copy it.')}</p></div>`;
                    showImageModal(message, [{text: _('Close'), class: 'btn-secondary'}]);
                });
            }

            function createMatrixBuilderUI(elemento) {
                const container = document.createElement('div');
                container.className = 'matrix-builder';
                container.dataset.title = _(elemento.title) || _('Matrix');
                container.innerHTML = `<div class="matrix-builder-group"><label for="mb-rows">${_('Rows:')}</label><input type="number" id="mb-rows" value="2" min="1" max="20"></div><div class="matrix-builder-group"><label for="mb-cols">${_('Columns:')}</label><input type="number" id="mb-cols" value="2" min="1" max="20"></div><div class="matrix-builder-group"><label for="mb-fill">${_('Fill:')}</label><select id="mb-fill"><option value="subscripts">${_('Subscripts (a, b...)')}</option><option value="zeros">${_('Zeros (0)')}</option><option value="ones">${_('Ones (1)')}</option><option value="vars">${_('Variables (a, b, c...)')}</option><option value="numbers">${_('Numbers (1, 2, 3...)')}</option><option value="empty">${_('Empty ({})')}</option></select></div><div class="matrix-builder-delimiters"><button class="btn" data-delimiter="pmatrix">()</button><button class="btn" data-delimiter="bmatrix">[]</button><button class="btn" data-delimiter="vmatrix">||</button><button class="btn" data-delimiter="Vmatrix">|||</button></div>`;
                container.querySelector('.matrix-builder-delimiters').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const rows = parseInt(container.querySelector('#mb-rows').value, 10);
                    const cols = parseInt(container.querySelector('#mb-cols').value, 10);
                    insertAtCursor(generateMatrixCode(rows, cols, container.querySelector('#mb-fill').value, button.dataset.delimiter));
                });
                return container;
            }

            function generateMatrixCode(rows, cols, fillType, delimiter) {
                if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) return '';
                let content = '', counter = 0;
                for (let i = 1; i <= rows; i++) {
                    for (let j = 1; j <= cols; j++) {
                        let cell;
                        switch(fillType) {
                            case 'subscripts': cell = `a_{${i}${j}}`; break;
                            case 'zeros': cell = '0'; break; case 'ones': cell = '1'; break;
                            case 'vars': cell = 'abcdefghijklmnopqrstuvwxyz'[counter % 26]; counter++; break;
                            case 'numbers': cell = (counter + 1).toString(); counter++; break;
                            case 'empty': cell = '{}'; break;
                            default: cell = '';
                        }
                        content += cell + (j < cols ? ' & ' : '');
                    }
                    if (i < rows) content += ' \\\\\n  ';
                }
                return `\\begin{${delimiter}}\n  ${content}\n\\end{${delimiter}}`;
            }

            function normalizeString(str) { return typeof str !== 'string' ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
            
            function renderTabContent(tabId, allCategories) {
                const contentDiv = document.getElementById(`tab-${tabId}`);
                if (!contentDiv) return;
                contentDiv.innerHTML = '';
                let elementsToRender = [], gridColumns = "repeat(auto-fill, minmax(80px, 1fr))";
                if (tabId === 'recientes') {
                    if (recentSymbols.length === 0) {
                         contentDiv.innerHTML = `<p style="color: var(--dark-gray); grid-column: 1 / -1; text-align:center;">${_('No recent symbols yet.')}</p><div id="clear-recents-btn-container" style="grid-column: 1 / -1;"><button id="clear-recents-btn" class="btn btn-sm btn-danger">${_('Clear recent')}</button></div>`;
                         if(document.getElementById('clear-recents-btn')) document.getElementById('clear-recents-btn').onclick = clearRecents;
                         return;
                    }
                    recentSymbols.forEach(latexCode => {
                        for (const menu of loadedMenus.values()) {
                            if (!menu.data || !menu.data.categorias) continue;
                            for (const categoria of menu.data.categorias) {
                                const found = categoria.elementos.find(el => el && el.latex === latexCode);
                                if (found) { elementsToRender.push(found); return; }
                            }
                        }
                    });
                } else {
                    const categoria = allCategories.get(tabId);
                    if (categoria) { elementsToRender = categoria.elementos; gridColumns = categoria.grid_template_columns || gridColumns; }
                }
                contentDiv.style.gridTemplateColumns = gridColumns;
                elementsToRender.forEach(elemento => {
                    if (!elemento) return;
                    if (elemento.type === 'custom_matrix') {
                        contentDiv.appendChild(createMatrixBuilderUI(elemento));
                    } else if (elemento.latex) {
                        const button = document.createElement('button');
                        button.className = 'toolbar-btn';
                        
                        // ===== MODIFICATION START =====
                        // 1. Translate the LaTeX content using the _() function, using display as primary and latex as fallback.
                        const translatedLatex = _(elemento.display || elemento.latex);
                        
                        // 2. Use the translated version for the data-latex attribute (what gets inserted).
                        button.dataset.latex = translatedLatex;
                        
                        // 3. Use the translated version for the button's visible content.
                        button.innerHTML = `\\(${translatedLatex}\\)`;
                        // ===== MODIFICATION END =====
                        
                        // The title is still translated independently.
                        button.title = _(elemento.title);
                        
                        contentDiv.appendChild(button);
                    }
                });
                if (tabId === 'recientes' && recentSymbols.length > 0) {
                     const clearBtnContainer = document.createElement('div');
                     clearBtnContainer.id = 'clear-recents-btn-container';
                     clearBtnContainer.style.gridColumn = '1 / -1';
                     clearBtnContainer.innerHTML = `<button id="clear-recents-btn" class="btn btn-sm btn-danger">${_('Clear recent')}</button>`;
                     clearBtnContainer.firstElementChild.onclick = clearRecents;
                     contentDiv.appendChild(clearBtnContainer);
                }
                MathJax.typesetPromise(contentDiv.querySelectorAll('.toolbar-btn'));
            }

            function handleTabSwitch(event) {
                const button = event.target.closest('.tab-btn');
                if (!button) return;
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                toolbar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(`tab-${tabId}`).classList.add('active');
                renderTabContent(tabId, getAllCategories());
            }
            
            // --- INITIALIZATION ---
            
            const initializeApp = async () => {
                loadRecents();
                loadedMenus.clear();
                menuCache.clear();
                let manifestMenus = [];
                try {
                    const manifestResponse = await fetch(MANIFEST_URL);
                    if (!manifestResponse.ok) throw new Error(_('Could not load') + ' menus.json');
                    const manifest = await manifestResponse.json();
                    manifestMenus = manifest.menus.filter(Boolean);
                } catch (e) {
                    console.error('Error loading menus.json:', e);
                    showAlert('Error', `Could not load <code>menus.json</code>.`);
                }
                const BASE_NAME = 'base.json';
                if (manifestMenus.find(m => m.file === BASE_NAME)) {
                    const data = await fetchMenuData(`./${BASE_NAME}`);
                    if (data) loadedMenus.set(BASE_NAME, { id: BASE_NAME, url: `./${BASE_NAME}`, source: 'default', name: 'Base', data });
                }
                const previouslyAdded = loadAddedMenusFromStorage();
                for (const menuInfo of previouslyAdded) {
                    if (menuInfo.id === BASE_NAME && loadedMenus.has(BASE_NAME)) continue;
                    const data = await fetchMenuData(menuInfo.url);
                    if (data) loadedMenus.set(menuInfo.id, { ...menuInfo, data });
                }
                window.__manifestMenus = manifestMenus;
                rebuildToolbarAndUI();
                updatePreview();
                addFooter();
            };

            // --- EVENT LISTENERS ---
            latexInput.addEventListener('input', updatePreview);
            toolbar.addEventListener('click', (event) => { const btn = event.target.closest('.toolbar-btn'); if (btn && btn.dataset.latex) insertAtCursor(btn.dataset.latex); });
            tabsContainer.addEventListener('click', handleTabSwitch);
            clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; searchInput.dispatchEvent(new Event('input', { bubbles: true })); searchInput.focus(); });
            copyButton.addEventListener('click', () => {
                const rawLatex = latexInput.value.trim();
                if (!rawLatex) return;
                let textToCopy;
                switch (delimiterSelector.value) {
                    case 'parentheses': textToCopy = `\\(${rawLatex}\\)`; break;
                    case 'brackets': textToCopy = `\\[\n${rawLatex}\n\\]`; break;
                    case 'double_dollar': textToCopy = `$$\n${rawLatex}\n$$`; break;
                    case 'single_dollar': textToCopy = `$${rawLatex}$`; break;
                    default: textToCopy = rawLatex;
                }
                navigator.clipboard.writeText(textToCopy);
                copyCodeFeedback.textContent = _('Code copied!');
                copyCodeFeedback.style.opacity = '1';
                setTimeout(() => { copyCodeFeedback.style.opacity = '0'; }, 2000);
            });
            clearButton.addEventListener('click', () => { latexInput.value = ''; latexInput.focus(); updatePreview(); });
            insertButton.addEventListener('click', () => {
                const rawLatex = latexInput.value.trim();
                if (!rawLatex) return;
                let latexToInsert;
                switch (delimiterSelector.value) {
                    case 'parentheses': latexToInsert = `\\(${rawLatex}\\)`; break;
                    case 'brackets': latexToInsert = `\\[${rawLatex}\\]`; break;
                    default: latexToInsert = rawLatex;
                }
                try {
                     const tinymceRef = parent && parent.tinymce ? parent.tinymce : null;
                    if (isInExe && tinymceRef && tinymceRef.activeEditor) {
                        tinymceRef.activeEditor.execCommand('mceReplaceContent', false, latexToInsert);
                        tinymceRef.activeEditor.windowManager?.close();
                        return;
                    }
                } catch(err){ console.error('Insert Error:', err);}
                window.close();
            });
            viewImageButton.addEventListener('click', handleViewImage);
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            
            // --- NEW EVENT LISTENER FOR URL BUTTON ---
            loadUrlBtn.addEventListener('click', async () => {
                const url = urlInput.value.trim();
                if (!url) {
                    showModalFeedback(_('Please enter a URL.'), true);
                    return;
                }
                // Use the URL as ID and derive a name from the filename
                const menuName = url.substring(url.lastIndexOf('/') + 1) || 'menu.json';
                const menuInfo = {
                    id: url, // The URL is a unique identifier
                    url: url,
                    source: 'url',
                    name: menuName
                };
                
                // addMenu handles UI reload and localStorage saving
                await addMenu(menuInfo); 
                showModalFeedback(_('Menu loaded successfully.'), false);
                urlInput.value = ''; // Clear the input after loading
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length === 0) return;
                const [file] = fileInput.files;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        loadedMenus.set(file.name, { id: file.name, url: file.name, source: 'localfile', name: file.name, data: parsed });
                        rebuildToolbarAndUI();
                        showModalFeedback(_('Menu loaded successfully.'), false);
                    } catch (err) {
                        console.error(_('Error parsing local JSON:'), err);
                        showModalFeedback(`${_('The file is not a valid JSON')} (${err.message})`, true);
                    }
                };
                reader.readAsText(file, 'utf-8');
                fileInput.value = '';
            });
            availableMenusList.addEventListener('change', (e) => { if(e.target.type !== 'checkbox') return; const ds = e.target.dataset; if (e.target.checked) addMenu(ds); else removeMenu(ds.id); });
            clearCacheBtn.addEventListener('click', () => location.reload(true));
            alertModalCloseBtn.addEventListener('click', hideAlert);
            askAiBtn.addEventListener('click', () => aiModal.classList.add('active'));
            closeAiModalBtn.addEventListener('click', () => aiModal.classList.remove('active'));
            generateAiPromptBtn.addEventListener('click', generateAiPrompt);
            copyAiPromptBtn.addEventListener('click', copyAiPrompt);
            maximizeBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => console.log(err));
                    maximizeBtn.textContent = '🗗';
                } else {
                    document.exitFullscreen();
                    maximizeBtn.textContent = '🗖';
                }
            });

            // Start the application
            initializeApp();
        }

        // Expose initializeLatexEditor to the global window object so MathJax can call it.
        window.initializeLatexEditor = initializeLatexEditor;
    </script>
</body>
</html>
